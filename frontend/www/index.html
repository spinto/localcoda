<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>localcoda</title>
  <style>

  @font-face {
    font-family: Outfit;
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url(Outfit-VariableFont_wght.ttf) format("woff");
    unicode-range: U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD
  }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body, html {
      height: 100%;
      width: 100%;
      font-family: Outfit,sans-serif!important;
      overflow: hidden;
    }

    body {
      margin: 0;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: rgb(85, 85, 85);
      background-color: #fff;
      text-align: start;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: rgba(0,0,0,0)
    }

    p {
      display: block;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      margin-top: 0;
      margin-bottom: 1rem;
      unicode-bidi: isolate;
    }

    a {
      text-decoration: none;
      cursor: pointer;
    }

    ul {
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      padding-inline-start: 40px;
      unicode-bidi: isolate;
    }
    ol, ul, dl {
      margin-top: 0;
      margin-bottom: 1rem;
    }
    ol, ul {
      padding-left: 2rem;
    }

    h6,.h6,h5,.h5,h4,.h4,h3,.h3,h2,.h2,h1,.h1 {
      margin-top: 0;
      margin-bottom: .5rem;
      font-weight: 500;
      line-height: 1.2;
    }

    /* Header */
    .header {
      background-color: black;
      color: white;
      padding: 10px 20px;
      font-size: 20px;
      height: 3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header a {
      color: #fff;
      text-decoration: none;
    }

    .header-right button {
      background: #fff;
      color: #000;
      border: none;
      padding: 6px 24px;
      border-radius: 0px;
      font-size: 1em;
      cursor: pointer;
      transition: 0.2s;
    }

    .header-right button:hover {
      background: #d3d4d5;
    }

    .header-right a {
      padding: 6px 12px;
    }

    .header-right {
      display: flex;
      gap: 10px; /* space between buttons */
      font-size: 0.8em;
    }

    /* Main */
    .main {
      padding: 40px 30px;
    }

    .main h2 {
      margin-bottom: 20px;
      font-size: 1.8em;
    }

    .main h2 a {
      color: rgb(85, 85, 85);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }

    .tile {
      border-radius: 0px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      text-align: center;
      height: 200px; /* ensures consistent tile size */
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    .tile:hover {
      transform: translateY(-5px);
    }

    .tile h3 {
      margin: 0;
      font-size: 1.2em;
    }

    .tile img {
      max-width: 80px;
      max-height: 80px;
      flex-grow: 1;
      margin: 10px 0;
      object-fit: contain;
    }

    .tile-black {
      background: #000;
      color: #fff;
    }

    .tile-grey {
      background: #f5f5f5;
      color: #555555;
    }

    .tile p {
      font-size: 0.9em;
      opacity: 0.8;
      margin: 0;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    .table th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      font-size: 0.9em;
    }

    .table th {
      background: #000;
      color: #fff;
    }

    .table tr:hover {
      background: #f0f0f0;
    }
  </style>
  <script>
    async function startup() {
      //Check if you are logged in
      await loginCheck();
      //Trigger the loading of the page (as the hash change will not fire itself)
      loadpage();
    }
    function dError(errorText) {
      document.getElementById('t').textContent = 'ERROR:'+errorText;
    }
    async function loginCheck(cl) {
      //Check if you are logged in or not
      try {
        const response = await fetch('ctl/me');  // Load JSON file
        if (!response.ok) throw new Error('Network response was not ok');
        me = await response.json();         // Parse JSON data
      } catch (error) {
        dError(error.message);
        return;
      }
    }
    async function loadpage() {
      //Clean page contents
      const pagecontents=document.getElementById('g');
      pagecontents.classList=[];
      pagecontents.innerHTML="";
      //Load current hash
      cl=window.location.hash;
      //Default page is browse
      if(cl=="") cl='#browse';
      //Redirect to the proper load page
      cl=cl.substring(1);
      if (cl.startsWith('browse')){
        loadPageBrowse(cl);
      } else if (cl.startsWith('list')){
        loadPageList(cl);
      } else if (cl.startsWith('run')){
        runScenario(cl);
      } else if (cl.startsWith('stop')){
        stopScenario(cl);
      } else {
        dError("ERROR: Wrong hash!")
      }
    }
    async function loadPageBrowse(cl) {
      if (!cl.startsWith('browse')){
        dError("ERROR: Wrong start for browse!");
        return;
      }
      document.getElementById('t').innerHTML="loading directory... please wait...";
      try {
        const response = await fetch('ctl/'+cl);  // Load JSON file
        if (!response.ok) throw new Error('Network response was not ok');
        structure = await response.json();         // Parse JSON data
      } catch (error) {
        dError(error.message);
        return;
      }
      let items=structure["items"];
      let gridHTML="";
      for (var ii in items) {
        i=items[ii];
        if (i['type']=='scenario') {
          gridLink="window.location.hash='"+cl.replace(/^browse/,'run')+"/"+i['path']+"'";
        }else{
          gridLink="window.location.hash='"+cl+"/"+i['path']+"'";
        }
        if ('theme' in i) {
          gridTheme=i['theme']
        } else {
          gridTheme='grey';
        }
        if ('img' in i) {
          gridImg='<img src="'+i['img']+'"/>';
        }else{
          gridImg="";
        }
        gridHTML=gridHTML+'<div class="tile tile-'+gridTheme+'" onclick="'+gridLink+'"><h3>'+i['title']+'</h3>'+gridImg+'<p>'+i['description']+'</p></div>';
      }
      document.getElementById('g').classList=['grid']
      document.getElementById('g').innerHTML=gridHTML;
      let gridTitle=""; let gridTitleBase="";
      let pathEl=structure['paths'];
      for (let ii=0; ii<pathEl.length; ii++){
        i=pathEl[ii];
        if (ii!=0) { gridTitle=gridTitle+" / " }
        gridTitle=gridTitle+"<a href=\"#browse"+i['path']+"\">"+i['title']+"</a>";
      }
      document.getElementById('p').innerHTML=gridTitle;
      if (structure.description) {
        document.getElementById('t').innerHTML=structure.description;
      }else{
        document.getElementById('t').innerHTML="";
      }
    }
    async function loadPageList(cl) {
      if (cl!='list'){
        dError("ERROR: Wrong start for list!");
        return;
      }
      document.getElementById('p').innerHTML="Running scenario instances";
      document.getElementById('t').innerHTML="listing instances... please wait...";

      try {
        const response = await fetch('ctl/ls');  // Load JSON file
        if (!response.ok) throw new Error('Network response was not ok');
        data = await response.json();         // Parse JSON data
      } catch (error) {
        dError(error.message);
        return;
      }

      if (data.length==0){
        document.getElementById('t').innerHTML="No scenario started. Start one from the <a style=\"color: blue\" href=\"#browse\">Areas</a> page";
        document.getElementById('g').innerHTML="";
        return;
      }
      document.getElementById('t').innerHTML="";

      // Check if all "user" values are the same
      const firstUser = data[0].user;
      const allSameUser = data.every(item => item.user === firstUser);

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      // Fixed Header Row
      const headerRow = document.createElement("tr");

      if (allSameUser) {
        ["ID", "Status", "Scenario", "Time remaning/elapsed", "Actions"].forEach(label => {
          const th = document.createElement("th");
          th.textContent = label;
          headerRow.appendChild(th);
        });
      } else {
        ["ID", "Status", "User", "Scenario", "Time remaning/elapsed", "Actions"].forEach(label => {
          const th = document.createElement("th");
          th.textContent = label;
          headerRow.appendChild(th);
        });
      }

      thead.appendChild(headerRow);

      // Data Rows
      data.forEach(item => {
        const row = document.createElement("tr");

        // ID
        let td = document.createElement("td");
        td.textContent = item.id;
        row.appendChild(td);

        // Status
        td = document.createElement("td");
        td.textContent = item.status;
        row.appendChild(td);

        // User
        if (!allSameUser) {
          td = document.createElement("td");
          td.textContent = item.user || "-";
          row.appendChild(td);
        }

        // Scenario
        td = document.createElement("td");
        scenarioPath=item.tutorial_path.substring(1).replace(/\/index\.json$/, "");
        scenariolink = document.createElement("a");
        scenariolink.href = "#browse/"+scenarioPath.replace(/[^/]*?$/, "");
        scenariolink.textContent = scenarioPath;
        td.appendChild(scenariolink);
        row.appendChild(td);

        // Time remaning/elapsed
        if(item['max_time']==-1){
          remaining_seconds=Math.floor(new Date().getTime() / 1000)-item['start_time'];
        }else{
          remaining_seconds=item['start_time'] + item['max_time'] - Math.floor(new Date().getTime() / 1000);
        }
        hours = Math.floor(remaining_seconds / 3600);
        minutes = Math.floor((remaining_seconds - (hours * 3600)) / 60);
        rt='';
        if(hours > 0) {
          rt=hours.toString() +' hours ';
        }
        rt=rt+minutes.toString()+' min';
        if(item['max_time']==-1){
          rt=rt+' elapsed';
        }
        td = document.createElement("td");
        td.textContent = rt;
        row.appendChild(td);

        // Actions
        td = document.createElement("td");
        td.classList.add("actions");

        if (item.status=="ready") {
          const terminalLink = document.createElement("a");
          terminalLink.href = item.access_url;
          terminalLink.target = "_blank";
          terminalLink.innerHTML = "&#x1F4BB;"; // laptop
          terminalLink.style = "margin-right: 10px";
          td.appendChild(terminalLink);
        }

        const trashLink = document.createElement("a");
        trashLink.href = '#stop/'+item.id;
        trashLink.innerHTML = "&#x1F5D1;"; // trash

        td.appendChild(trashLink);

        row.appendChild(td);
        tbody.appendChild(row);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      // Set table
      const pagecontents=document.getElementById('g');
      pagecontents.classList=['table'];
      pagecontents.innerHTML="";
      pagecontents.appendChild(table);
    }
    async function runScenario(cl) {
      if (!cl.startsWith('run')){
        dError("ERROR: Wrong start for run!");
        return;
      }
      document.getElementById('p').innerHTML="Starting scenario...";
      document.getElementById('t').innerHTML="Please wait for scenario to start to be redirected...";
      //Run the scenario
      try {
        const response = await fetch('ctl/'+cl);  // Load JSON file
        if (!response.ok) throw new Error('Network response was not ok');
        instance = await response.json();         // Parse JSON data
      } catch (error) {
        dError(error.message);
        return;
      }
      //If we got the UUID, all is ok
      if (!instance.uuid) {
        dError("Failed to run scenario");
        return
      }
      //Wait till the scenario is ready, till a timeout is reached
      for (let run_timeout=120; run_timeout>0; run_timeout=run_timeout-1) {
        try {
          const response = await fetch('ctl/ls/'+instance.uuid);  // Load JSON file
          if (!response.ok) throw new Error('Network response was not ok');
          run = await response.json();         // Parse JSON data
          if (run[0]['status']=='ready') break;
        } catch (error) {
          dError(error.message);
          return;
        }
        
        //Sleep for one second
        await new Promise(r => setTimeout(r, 1000));
      }
      if (run[0]['status']=='ready') {
        window.location=run[0]['access_url']
      } else {
        dError("Timeout reached while trying to start scenario.");
      }

    }
    async function stopScenario(cl) {
      if (!cl.startsWith('stop')){
        dError("ERROR: Wrong start for run!");
        return;
      }
      document.getElementById('p').innerHTML="Stopping scenario...";
      document.getElementById('t').innerHTML="Please wait to be redirected...";
      //Stopping scenario
      try {
        const response = await fetch('ctl/'+cl);  // Load JSON file
        if (!response.ok) throw new Error('Network response was not ok');
        structure = await response.json();         // Parse JSON data
      } catch (error) {
        document.getElementById('t').textContent = 'Failed to load options: ' + error.message;
        return;
      }
      //Got back to list
      window.location.hash='list';
    }
  </script>
</head>
<body onhashchange="loadpage();" onload="startup();">

  <!-- Header -->
  <div class="header">
    <a href="#">localcoda</a>
    <div class="header-right">
      <a href="#browse">Areas</a>
      <a href="#list">Scenarios</a>
      <button id="userlogin" class="login-btn" href="oidc/auth">Login</button>
    </div>
  </div>

  <!-- Waiting -->
  <span id="waiting"></span>

  <!-- Main Content -->
  <div class="main">
    <h2 id="p"></h2>
    <p id="t"></p>
    <div id="g">
    </div>
  </div>

</body>
</html>
